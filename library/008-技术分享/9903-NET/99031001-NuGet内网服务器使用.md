# NuGet 内网服务器使用说明
> 维护人员: 潘景福    
> 创建时间: 2016-12-20  

[TOC]

## 在 Visual Studio 项目中使用内网 NuGet 源

*本文以 Visual Studio 2013 为例*

### 添加程序包源

* 打开 VS 的 NuGet 程序包源管理

![1](assets/share/20161220/nuget-1.png)

* 点击新增程序包源
* 名称填写 `Soolife Package Source`
* 源填写 `http://172.16.1.20:11801/repository/nuget-group/`
* 点击确定完成源的添加



### 项目中引用程序包

* 打开项目的 NuGet 程序包管理    
  ![2](assets/share/20161220/nuget-2.png)


* 选择 Soolife Package Source 源，搜索我们自己自己发布的 NuGet 包    
  ![3](assets/share/20161220/nuget-3.png)


* 安装所需要的包即可




## 发布程序包到内网服务器

> 发布地址: http://172.16.1.20:11801/repository/nuget-hosted/
>
> 发布密钥: b72aafcf-1186-32a0-b04a-5b2a1660a318

*这里不进行 NuGet 包发布的深入研究，仅介绍最简单的发布一个 NuGet 包的方法*



### 安装 NuGet Package Explorer

* 使用 ClickOne 方式安装

  https://npe.codeplex.com/downloads/get/clickOnce/NuGetPackageExplorer.application

* 安装完成后的启动界面如下：

![4](assets/share/20161220/nuget-4.png)



### 程序包基本参数

* 点击 `Create a new package`

* 点击左边 `Package metadata` 的属性小图标

  ![5](assets/share/20161220/nuget-5.png)

* 填写包的基本属性

  ![6](assets/share/20161220/nuget-6.png)

### 程序包包含的文件

* 以我们的通用方法程序包 Soolife.Common 为例

* 在右侧 Package contents 空白处，右键 `Add Lib Folder`

* 在出现的 lib 节点右键 `Add .NET folder`  -> `v4.5.2`，表示该目录的内容面向目标版本为 v4.5.2 以上的.Net Frameworks，也可以为不同 .Net 版本添加多个目录，然后在 net452 目录上右键 `Add Existing files...`，添加我们这个包所要包含的文件，通常为 dll + xml

  ![7](assets/share/20161220/nuget-7.png)



### 程序包的依赖项目

* 通常我们的程序包可能还会依赖其他程序包才能运行，如 Soolife.Common 里的 Json 处理方法依赖 Newtonsoft.Json 库，又比如 Soolife.Data.MySql 库也依赖 Soolife.Common 库。而这些额外的库都是单独打包发布的，将它们的dll合并在我们的包发布显然不合适，这也容易造成同一个项目引用同一个库的不同版本而产生冲突，所以我们需要为包配置依赖库，以便包管理程序自动处理这些依赖库
* 点击 `Package metadata` 最下面的 `Edit dependencies` 按钮
* 在 `Package Dependency Editor` 窗口，先添加一个 Group，命名为 `net452` ，`Target framework`  填 `net452`。
* 点击下面的属性按钮，在弹出的 `Select Package` 窗口中搜索并选择要添加的依赖库并，然后回到上个窗口点击右下角的 `+` 按钮添加这个依赖库（如图，Newtonsoft.Json 9.0.1 就是添加好的依赖库）

![8](assets/share/20161220/nuget-8.png)



### 发布程序包

* 点击`Package metadata` 的 `√` 按钮即可预览的我们的包设置

![9](assets/share/20161220/nuget-9.png)

* 确认我们的包信息正确

* 点击菜单 `FILE` -> `Save Metadata As...` 保存我们的包配置信息以便下次使用

  > `Save ` 和 `Save As..` 是直接保存包含程序集信息的最终`.nupkg`文件，不方便下次编辑使用，仅需要时使用

* 点击 `FILE` -> `Publish...`

* 填写 `Publish Url` 和 `Publish Key`，去掉 `Append 'api/v2/package' to publish url` 的勾选

* 点击 Publish 按钮发布即可

  ![10](assets/share/20161220/nuget-10.png)

* 发布成功会提示 `Package published successfully`，否则会提示相应的错误信息。





## 修订记录

| 版本   | 日期         | 说明   | 修订人  |
| ---- | ---------- | ---- | ---- |
| 0.1  | 2016-12-20 | 初版   | 潘景福  |
